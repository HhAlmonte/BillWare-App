@page "/category/index"

@inject ICategoryService _categoryService
@inject DialogService DialogService;

<h3>Categorias</h3>

<hr />


<RadzenButton Text="AGREGAR" Click="@(async() => await OpenAddDialogForm("Agregar categoria"))" class="mb-3 mt-3" Style="background-color:#003053; color: #FFF" />
<RadzenTextBox Placeholder="Presiona ENTER al buscar" Change="@(async(e) => await GetBySearch(e))"/>

<RadzenDataGrid Data="Categories"
                TItem="Category"
                ShowPagingSummary="true"
                PagingSummaryFormat="@pagingSummaryFormat">
    <EmptyTemplate>
        <p style="color: lightgrey; font-size: 24px; text-align: center; margin: 2rem;">No records to display.</p>
    </EmptyTemplate>
        <Columns>
        <RadzenDataGridColumn TItem="Category"
                              Property="Id"
                              Title="Identificador">
            <Template Context="data">
                @data.Id.ToString("D3")
            </Template>
        </RadzenDataGridColumn>
            <RadzenDataGridColumn TItem="Category"
                                  Property="Name"
                                  Title="Nombre">
            </RadzenDataGridColumn>
            <RadzenDataGridColumn TItem="Category"
                              Property="Description"
                              Title="Descripción">
            </RadzenDataGridColumn>
            <RadzenDataGridColumn TItem="Category"
                              Title="Fecha de Creación">
                       <Template Context="date">
                           @date.CreatedAt.ToString("dd/MM/yyyy hh:mm")
                       </Template>
            </RadzenDataGridColumn>
            <RadzenDataGridColumn TItem="Category"
                                  Title="Acciones"
                                  Context="data"
                                  TextAlign="TextAlign.Center">
                    <Template>
                        <RadzenButton ButtonStyle="ButtonStyle.Warning" Icon="edit" Click="@(() => OpenEditDialogForm("Editar categoria", data))"/>
                        <RadzenButton ButtonStyle="ButtonStyle.Danger" Icon="delete" Click="@(async() => await Delete(data.Id))"/>
                    </Template>
            </RadzenDataGridColumn>
        </Columns>
</RadzenDataGrid>

<RadzenPager PageSize="BaseResponse.PageSize"
             Count="BaseResponse.TotalItems"
             PageChanged="@(async(e) => await PageIndexChanged(e.PageIndex))"
             PageSizeOptions="PageSizeOptions"
             PageSizeText="registros por página"
             HorizontalAlign="HorizontalAlign.Left"
             PageSizeChanged="@(async(e) => await PageSizeChanged(e))"
             ShowPagingSummary="true"
             PagingSummaryFormat="@pagingSummaryFormat">
</RadzenPager>

@if(IsLoading)
{
    <LoadingOverlay />
}

@code {
    private BaseResponseModel<Category> BaseResponse { get; set; } = new BaseResponseModel<Category>();
    private List<Category> Categories { get; set; } = new List<Category>();
    private IEnumerable<int> PageSizeOptions { get; set; } = new int[] { 5, 10, 20, 50 };
    private bool IsLoading { get; set; } = false;
    private bool IsFiltered { get; set; } = false;
    private string Search { get; set; } = "";

    private int PageSize { get; set; } = 5;
    private int PageIndex { get; set; } = 1;
    private string pagingSummaryFormat = "Desplegando página {0} de {1} total {2} registros";

    private async Task LoadData(int pageIndex, int pageSize = 5)
    {
        BaseResponse = await _categoryService.GetCategories(pageIndex, pageSize);
        Categories = BaseResponse.Items;
    }

    protected override async Task OnInitializedAsync()
    {
        IsLoading = true;
        await LoadData(PageIndex);

        await Task.Delay(1000);
        IsLoading = false;
    }

    private async Task PageIndexChanged(int pageIndex)
    {
        PageIndex = pageIndex+1;

        if(IsFiltered)
        {
            await GetBySearch(Search);
        }
        else
        {
            await LoadData(PageIndex, PageSize);
        }
    }

    private async Task PageSizeChanged(int pageSize)
    {
        PageSize = pageSize;

        if(IsFiltered)
        {
            await GetBySearch(Search);
        }
        else
        {
            await LoadData(PageIndex, PageSize);
        }
    }

    private async Task Delete(int id)
    {
        var isConfirmed = await SweetAlertServices.ShowWarningAlert("¿Estás seguro de eliminar este registro?", "Verifica que este registro sea el que quieres eliminar");

        if (isConfirmed)
        {
            var action = await _categoryService.DeleteCategory(id);

            if (!action.IsSuccessStatusCode)
            {
                await SweetAlertServices.ShowErrorAlert("Ocurrió un error", await action.Content.ReadAsStringAsync());
            }
            else
            {
                await LoadData(PageIndex, PageSize);
            }
        }
    }

    private async Task GetBySearch(string search)
    {
        IsFiltered = true;
        Search = search;

        if(Search == "")
        {
            IsFiltered = false;
            await LoadData(PageIndex, PageSize);
            return;
        }
        else
        {
            BaseResponse = await _categoryService.GetCategoryWithSearch(search, PageIndex, PageSize);
            Categories = BaseResponse.Items;
        }
    }

    private async Task OpenAddDialogForm(string title)
    {
        var action = await DialogService.OpenAsync<CategoryForm>(title, 
        new Dictionary<string, object>
        {
            { "FormMode", Common.FormMode.ADD }
        },
        new DialogOptions
        {
            Width = "auto"
        });

        var isLoad = action == null ? false : true;

        if (isLoad)
        {
            IsLoading = true;
            await LoadData(PageIndex, PageSize);

            await Task.Delay(1000);
            IsLoading = false;
        }
    }

    private async Task OpenEditDialogForm(string title, Category category)
    {
        var action = await DialogService.OpenAsync<CategoryForm>(title, 
        new Dictionary<string, object>
        {
            { "FormMode", Common.FormMode.EDIT },
            { "CategoryParameter", category }
        },
        new DialogOptions
        {
            Width = "auto",
        });

        var isLoad = action == null ? false : true; 

        if (isLoad)
        {
            IsLoading = true;
            await LoadData(PageIndex, PageSize);

            await Task.Delay(1000);
            IsLoading = false;
        }
    }
}
